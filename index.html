<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘å­¦å•å…ƒé—¯å…³ï¼šå…¨çœŸæ¨¡æ‹Ÿå·</title>
    <style>
        /* ================== æ ·å¼è¡¨ (ä¿æŒåŸæ ·) ================== */
        :root { --primary-color: #00BCD4; --accent-color: #FF9800; --bg-color: #E0F7FA; --card-bg: #FFFFFF; --correct-color: #4CAF50; --wrong-color: #F44336; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); margin: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; color: #333; padding: 20px 0; }
        .container { width: 90%; max-width: 800px; background: var(--card-bg); border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; margin-bottom: 50px; }
        header { background: var(--primary-color); color: white; padding: 20px; text-align: center; font-size: 1.5em; font-weight: bold; }
        .progress-bar { height: 10px; background: rgba(255,255,255,0.3); margin-top: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s ease; }
        .game-area { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        canvas { background: #fff; border: 2px dashed #ccc; border-radius: 10px; margin-bottom: 20px; display: none; max-width: 100%; }
        .question-text { font-size: 1.2em; margin-bottom: 20px; line-height: 1.6; text-align: center; font-weight: 500; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; }
        @media(min-width: 600px) { .options-grid { grid-template-columns: 1fr 1fr; } }
        .option-btn { background: #f9f9f9; border: 2px solid #e0e0e0; padding: 15px; border-radius: 12px; cursor: pointer; font-size: 1.05em; transition: all 0.2s; text-align: left; position: relative; }
        .option-btn:hover { background: #e0f7fa; border-color: var(--primary-color); }
        .option-btn.selected { background: #B2EBF2; border-color: #00838F; font-weight: bold; }
        .next-btn { margin-top: 30px; padding: 12px 40px; background: var(--accent-color); color: #fff; font-weight: bold; border: none; border-radius: 25px; font-size: 1.1em; cursor: pointer; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .next-btn:hover { background: #f57c00; transform: scale(1.05); }
        
        .result-screen { display: none; padding: 20px; background: #fdfdfd; }
        .score-header { text-align: center; padding-bottom: 20px; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .final-score { font-size: 3em; color: var(--primary-color); font-weight: bold; }
        .score-comment { color: #666; margin-top: 10px; }
        .review-list { display: flex; flex-direction: column; gap: 20px; }
        .review-item { border: 1px solid #eee; border-radius: 10px; padding: 15px; background: #fff; }
        .review-item.wrong { border-left: 5px solid var(--wrong-color); }
        .review-item.correct { border-left: 5px solid var(--correct-color); }
        .review-q-title { font-weight: bold; margin-bottom: 10px; }
        .review-status { font-size: 0.9em; margin-bottom: 5px; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; color: white; font-size: 0.8em; margin-right: 10px; }
        .badge-correct { background: var(--correct-color); }
        .badge-wrong { background: var(--wrong-color); }
        .review-detail { font-size: 0.9em; color: #555; background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .answer-compare { margin-bottom: 5px; }
        .correct-text { color: var(--correct-color); font-weight: bold; }
        .wrong-text { color: var(--wrong-color); font-weight: bold; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal-card { background: white; padding: 30px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-group { margin: 15px 0; text-align: left; }
        .form-label { font-size: 0.9em; color: #666; margin-bottom: 5px; display: block; font-weight: bold;}
        .input-field { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1em; outline: none; transition: 0.3s; box-sizing: border-box; }
        .input-field:focus { border-color: var(--primary-color); }
        select.input-field { background-color: white; }
        .start-btn { background: var(--primary-color); color: white; padding: 12px 40px; border: none; border-radius: 25px; font-size: 1.1em; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px;}
        .upload-status { margin-top: 15px; font-size: 0.95em; color: #666; padding: 10px; background: #f5f5f5; border-radius: 8px; }
        
        /* è¿™é‡Œçš„å†æµ‹ä¸€æ¬¡æŒ‰é’®å®¹å™¨å·²è¢«ç§»é™¤ */
        .restart-btn-container { display: none; } 
    </style>
</head>
<body>

<div class="modal-overlay" id="login-modal">
    <div class="modal-card">
        <h2>ğŸ‘‹ æ¬¢è¿æ¥åˆ°ç§‘å­¦é—¯å…³</h2>
        <p style="color:#666; margin-bottom:20px;">è¯·å¡«å†™ä¿¡æ¯ï¼Œå¼€å§‹æŒ‘æˆ˜å§ï¼</p>
        <div class="form-group">
            <label class="form-label">é€‰æ‹©ç­çº§ï¼š</label>
            <select id="student-class" class="input-field">
                <option value="" disabled selected>-- è¯·ç‚¹å‡»é€‰æ‹© --</option>
                <option value="ä¸‰ï¼ˆ1ï¼‰ç­">ä¸‰ï¼ˆ1ï¼‰ç­</option>
                <option value="ä¸‰ï¼ˆ2ï¼‰ç­">ä¸‰ï¼ˆ2ï¼‰ç­</option>
                <option value="ä¸‰ï¼ˆ3ï¼‰ç­">ä¸‰ï¼ˆ3ï¼‰ç­</option>
                <option value="ä¸‰ï¼ˆ4ï¼‰ç­">ä¸‰ï¼ˆ4ï¼‰ç­</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">ä½ çš„åå­—ï¼š</label>
            <input type="text" id="student-name" class="input-field" placeholder="ä¾‹å¦‚ï¼šå¼ å°æ˜" />
        </div>
        <button class="start-btn" onclick="startGame()">ğŸš€ å¼€å§‹æŒ‘æˆ˜</button>
    </div>
</div>

<div class="container">
    <header>
        <div>ğŸ“ ç§‘å­¦å•å…ƒæ¨¡æ‹Ÿé—¯å…³</div>
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
    </header>

    <div class="game-area" id="game-area">
        <canvas id="questionCanvas" width="400" height="220"></canvas>
        <div class="question-text" id="question-text">åŠ è½½ä¸­...</div>
        <div class="options-grid" id="options-container"></div>
        <button class="next-btn" id="next-btn" onclick="nextQuestion()">ç¡®å®šï¼Œä¸‹ä¸€é¢˜</button>
    </div>

    <div class="result-screen" id="result-screen">
        <div class="score-header">
            <div style="background:#FFF3E0; color:#E65100; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9em; display:none;" id="already-submitted-msg">âš ï¸ æ‚¨å·²å®Œæˆæœ¬æ¬¡è€ƒè¯•ï¼Œä»¥ä¸‹æ˜¯æ‚¨çš„æˆç»©å•</div>
            
            <div>
                <span style="background:#E0F7FA; padding:2px 8px; border-radius:4px; font-size:0.8em; color:#006064;" id="player-class-display"></span> 
                <span id="player-name-display"></span> çš„æˆç»©ï¼š
            </div>
            <div class="final-score" id="final-score-display">0</div>
            <div class="score-comment" id="score-comment"></div>
            <div class="upload-status" id="upload-status">â³ æ­£åœ¨è®¡ç®—åˆ†æ•°...</div>
        </div>
        <h3>ğŸ“Š è¯¦ç»†â€œä½“æ£€æŠ¥å‘Šâ€</h3>
        <div class="review-list" id="review-list"></div>
        
        </div>
</div>

<script>
// =========================================================
// âš ï¸ å¿…å¡«é…ç½®åŒºï¼šè¯·å¡«å…¥é£ä¹¦å¼€æ”¾å¹³å°çš„ä¿¡æ¯ âš ï¸
// =========================================================

// 1. é£ä¹¦è‡ªå»ºåº”ç”¨çš„ App ID (cli_ å¼€å¤´)
const APP_ID = "cli_a9b7a11e88b8dccd"; 

// 2. é£ä¹¦è‡ªå»ºåº”ç”¨çš„ App Secret
const APP_SECRET = "KUq1vkGP1QHUAq6FCA7W5baEqRmoUCvb"; 

// 3. å¤šç»´è¡¨æ ¼çš„ App Token (æµè§ˆå™¨åœ°å€æ  base/ åé¢çš„å­—ç¬¦ä¸²)
const BITABLE_APP_TOKEN = "DxwzbJ3jtajSxOsOH3Nc3tixnjL"; 

// 4. æ•°æ®è¡¨çš„ Table ID (æµè§ˆå™¨åœ°å€æ  table= åé¢çš„å­—ç¬¦ä¸²)
const BITABLE_TABLE_ID = "tbl3JDZDBfR9LdEg"; 

// ä»£ç†åœ°å€ (è§£å†³æµè§ˆå™¨è·¨åŸŸé—®é¢˜)
const PROXY_URL = "https://corsproxy.io/?";

// =========================================================

let playerName = "";
let playerClass = ""; 
let currentQIndex = 0;
let userAnswers = [];

const questions = [
    { q: "ã€è§‚å¯Ÿåˆ†æã€‘å°æ˜æƒ³æ¯”è¾ƒæ°´ã€ç‰›å¥¶å’Œæ´—æ´ç²¾è°æµå¾—æœ€å¿«ï¼Œä»–åœ¨å€¾æ–œçš„ç»ç’ƒæ¿ä¸Šè¿›è¡Œæ¯”èµ›ã€‚è¿™ä¸»è¦æ˜¯åœ¨æ¯”è¾ƒæ¶²ä½“çš„ä»€ä¹ˆç‰¹å¾ï¼Ÿ", options: ["A. é¢œè‰²", "B. æ°”å‘³", "C. é»åº¦ (æµåŠ¨æ€§)", "D. é€æ˜åº¦"], answer: 2, level: "åˆ†æ", explanation: "ä¸åŒæ¶²ä½“çš„é»åº¦ä¸åŒï¼Œè¶Šé»ç¨ çš„æ¶²ä½“æµåŠ¨é€Ÿåº¦é€šå¸¸è¶Šæ…¢ã€‚", type: "normal" },
    { q: "ã€ç”Ÿæ´»åº”ç”¨ã€‘ç›²ç›’çŒœç‰©ï¼šæ‘¸èµ·æ¥ç¡¬ç¡¬çš„ï¼Œæä¸åŠ¨ï¼Œè€Œä¸”ä¸ç®¡æ”¾åœ¨å“ªé‡Œå½¢çŠ¶éƒ½ä¸ä¼šå˜ã€‚å®ƒæœ€å¯èƒ½æ˜¯ä»€ä¹ˆï¼Ÿ", options: ["A. æ°”çƒé‡Œçš„ç©ºæ°”", "B. æœ¨å¤´ç§¯æœ¨", "C. è¢‹è£…ç‰›å¥¶", "D. ç‰™è†"], answer: 1, level: "è®°å¿†", explanation: "è¿™æ˜¯å›ºä½“çš„å…¸å‹ç‰¹å¾ï¼šæœ‰å›ºå®šçš„å½¢çŠ¶å’Œä½“ç§¯ï¼Œè´¨åœ°è¾ƒç¡¬ã€‚", type: "normal" },
    { q: "ã€å®éªŒè¯»æ•°ã€‘è¯·ä»”ç»†è§‚å¯Ÿé‡ç­’ä¸­çš„æ°´é¢ï¼ˆå¦‚ä¸Šå›¾ï¼‰ã€‚æ­£ç¡®çš„è¯»æ•°åº”è¯¥æ˜¯å¤šå°‘ï¼Ÿ", options: ["A. 38ml", "B. 40ml", "C. 42ml", "D. 50ml"], answer: 1, level: "åº”ç”¨", explanation: "è¯»æ•°æ³•åˆ™ï¼šè§†çº¿è¦ä¸å‡¹æ¶²é¢çš„æœ€ä½å¤„ä¿æŒæ°´å¹³ã€‚å›¾ä¸­æ¶²é¢æœ€ä½å¤„æ­£å¥½å¯¹å‡†40mlåˆ»åº¦çº¿ã€‚", type: "cylinder", drawingParam: { level: 40 } },
    { q: "ã€ç§‘å­¦æ¨æ–­ã€‘çš®çƒæ‰“è¶³æ°”åä¼šå˜å¾—æ›´é‡ä¸€ç‚¹ï¼Œè¿™è¯´æ˜äº†ç©ºæ°”å…·æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ", options: ["A. ç©ºæ°”æ˜¯é€æ˜çš„", "B. ç©ºæ°”æœ‰è´¨é‡", "C. ç©ºæ°”ä¼šæµåŠ¨", "D. ç©ºæ°”æœ‰å¼¹æ€§"], answer: 1, level: "ç†è§£", explanation: "è™½ç„¶ç©ºæ°”å¾ˆè½»ï¼Œä½†å®ƒä¹Ÿæ˜¯ç‰©è´¨ï¼Œå…·æœ‰è´¨é‡ã€‚æ‰“å…¥æ›´å¤šç©ºæ°”ï¼Œè´¨é‡è‡ªç„¶å¢åŠ ã€‚", type: "normal" },
    { q: "ã€å®éªŒåˆ†æã€‘ç”¨åŠ›æ¨æ³¨å°„å™¨çš„æ´»å¡ï¼Œå¦‚æœæ˜¯ç©ºæ°”å¾ˆå®¹æ˜“è¢«å‹ç¼©ï¼Œå¦‚æœæ˜¯æ°´åˆ™å¾ˆéš¾ã€‚è¿™è¯´æ˜ï¼š", options: ["A. ç©ºæ°”å¾®ç²’é—´éš™å¤§ï¼Œæ˜“è¢«å‹ç¼©", "B. æ°´æ¯”ç©ºæ°”é‡", "C. æ°´æ˜¯æœ‰é¢œè‰²çš„", "D. åªæœ‰ç©ºæ°”å æ®ç©ºé—´"], answer: 0, level: "åˆ†æ", explanation: "æ°”ä½“çš„å¾®ç²’é—´è·å¤§ï¼Œå®¹æ˜“è¢«æŒ¤å‹ï¼›æ¶²ä½“çš„å¾®ç²’é—´è·å¾ˆå°ï¼Œéš¾ä»¥è¢«å‹ç¼©ã€‚", type: "syringe", drawingParam: { compressed: true } },
    { q: "ã€æ¦‚å¿µè¾¨æã€‘æŠŠä¸€æ¯æ°´å€’å…¥å„ç§ä¸åŒå½¢çŠ¶çš„ç“¶å­é‡Œï¼Œæ°´çš„ä»€ä¹ˆå‘ç”Ÿäº†å˜åŒ–ï¼Ÿ", options: ["A. ä½“ç§¯", "B. è´¨é‡", "C. å½¢çŠ¶", "D. éƒ½æ²¡æœ‰å˜"], answer: 2, level: "ç†è§£", explanation: "æ¶²ä½“â€œæ— å›ºå®šå½¢çŠ¶â€ï¼Œå½¢çŠ¶éšå®¹å™¨è€Œå˜ï¼›ä½†â€œæœ‰å›ºå®šä½“ç§¯â€ï¼Œå¤šå°‘ä¸ä¼šå˜ã€‚", type: "normal" },
    { q: "ã€ç‰©è´¨å˜åŒ–ã€‘å°†ä¸€å‹ºç™½ç³–æ”¾å…¥æ°´ä¸­æ…æ‹Œï¼Œè¿‡ä¸€ä¼šå„¿ç™½ç³–â€œä¸è§äº†â€ï¼Œè¿™è¯´æ˜ç™½ç³–ï¼Ÿï¼ˆå¦‚ä¸Šå›¾ç¤ºæ„ï¼‰", options: ["A. è’¸å‘äº†", "B. æ²‰åˆ°æ°´åº•äº†", "C. åœ¨æ°´ä¸­æº¶è§£äº†", "D. å˜æˆäº†æ°´"], answer: 2, level: "ç†è§£", explanation: "ç™½ç³–å¹¶æ²¡æœ‰æ¶ˆå¤±ï¼Œè€Œæ˜¯å˜æˆäº†æå°çš„å¾®ç²’å‡åŒ€åˆ†æ•£åœ¨æ°´ä¸­ï¼Œè¿™ç§ç°è±¡å«æº¶è§£ã€‚", type: "dissolve", drawingParam: {} },
    { q: "ã€é—®é¢˜è§£å†³ã€‘å¦‚æœä¸å°å¿ƒæŠŠæœ¨å±‘æ··è¿›äº†æ²™å­é‡Œï¼Œåˆ©ç”¨æ°´å¯ä»¥æŠŠå®ƒä»¬åˆ†ç¦»å¼€ï¼ˆå¦‚ä¸Šå›¾ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºï¼Ÿ", options: ["A. æœ¨å±‘ä¼šæº¶è§£åœ¨æ°´é‡Œ", "B. æ²™å­ä¼šæµ®åœ¨æ°´é¢ä¸Š", "C. æœ¨å±‘æµ®åœ¨æ°´é¢ï¼Œæ²™å­æ²‰åœ¨æ°´åº•", "D. åªæœ‰ç”¨çƒ­æ°´æ‰è¡Œ"], answer: 2, level: "åº”ç”¨", explanation: "åˆ©ç”¨æµ®æ²‰æ€§è´¨çš„ä¸åŒï¼šæœ¨å¤´å¯†åº¦å°æµ®äºæ°´é¢ï¼Œæ²™çŸ³å¯†åº¦å¤§æ²‰å…¥æ°´åº•ï¼Œä»è€Œå®ç°åˆ†ç¦»ã€‚", type: "separation", drawingParam: {} },
    { q: "ã€ç”Ÿæ´»åº”ç”¨ã€‘å¦‚æœç»¿è±†é‡Œä¸å°å¿ƒæ··è¿›äº†é¢ç²‰ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä»€ä¹ˆå·¥å…·æŠŠå®ƒä»¬å¿«é€Ÿåˆ†å¼€ï¼Ÿåˆ©ç”¨äº†ä»€ä¹ˆåŸç†ï¼Ÿ", options: ["A. ç£é“ï¼ˆåˆ©ç”¨æ˜¯å¦æœ‰ç£æ€§ï¼‰", "B. ç­›å­ï¼ˆåˆ©ç”¨é¢—ç²’å¤§å°ä¸åŒï¼‰", "C. æ°´ï¼ˆåˆ©ç”¨æ˜¯å¦æº¶è§£ï¼‰", "D. æ™’å¤ªé˜³ï¼ˆåˆ©ç”¨è’¸å‘ï¼‰"], answer: 1, level: "åˆ›é€ ", explanation: "é¢ç²‰é¢—ç²’å¾ˆå°ï¼Œç»¿è±†é¢—ç²’å¾ˆå¤§ã€‚åˆ©ç”¨ç­›å­ï¼ˆç½‘æ ¼ï¼‰ï¼Œå°çš„é¢ç²‰æ¼ä¸‹å»ï¼Œå¤§çš„ç»¿è±†ç•™åœ¨ä¸Šé¢ã€‚", type: "sieve", drawingParam: {} },
    { q: "ã€å®éªŒå·¥å…·ã€‘å¤©å¹³æŒ‡é’ˆå‘å·¦åï¼ˆå¦‚ä¸Šå›¾ï¼‰ï¼Œè¦è®©å¤©å¹³å¹³è¡¡ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ", options: ["A. è°ƒèŠ‚å·¦ç«¯çš„å¹³è¡¡èºæ¯å‘å·¦", "B. å‘å³ç›˜æ·»åŠ ç ç æˆ–æ¸¸ç å³ç§»", "C. å¢åŠ å·¦ç›˜çš„ç‰©ä½“", "D. ç”¨æ‰‹æ‰˜ä¸€ä¸‹"], answer: 1, level: "åº”ç”¨", explanation: "å·¦åè¯´æ˜å·¦è¾¹é‡ã€‚éœ€è¦åœ¨è½»çš„ä¸€è¾¹ï¼ˆå³è¾¹ï¼‰å¢åŠ é‡é‡ï¼ˆç ç /æ¸¸ç ï¼‰æ¥å¹³è¡¡ã€‚", type: "balance", drawingParam: { tilt: -1 } },
    { q: "ã€é€»è¾‘åˆ¤æ–­ã€‘ä¸‹é¢å“ªä¸€ç»„ç‰©ä½“éƒ½å±äºâ€œæ¶²ä½“â€ï¼Ÿ", options: ["A. æ°´ã€ç‰›å¥¶ã€é…±æ²¹", "B. çŸ³å¤´ã€æœ¨å—ã€æ²™å­", "C. ç©ºæ°”ã€æ°§æ°”ã€æ°´è’¸æ°”", "D. æ°´ã€å†°ã€å¯ä¹"], answer: 0, level: "åˆ†æ", explanation: "Aç»„å…¨ä¸ºæ¶²ä½“ï¼›Bç»„ä¸ºå›ºä½“ï¼›Cç»„ä¸ºæ°”ä½“ï¼›Dç»„ä¸­å†°æ˜¯å›ºä½“ã€‚", type: "normal" },
    { q: "ã€å®éªŒè®¡ç®—ã€‘é‡ç­’é‡Œæœ‰30mlæ°´ï¼Œæ”¾å…¥ä¸€ä¸ªçŸ³å—åæ°´ä½å‡åˆ°55mlï¼ˆå¦‚ä¸Šå›¾ï¼‰ã€‚çŸ³å—ä½“ç§¯æ˜¯å¤šå°‘ï¼Ÿ", options: ["A. 85ml", "B. 55ml", "C. 25ml", "D. 30ml"], answer: 2, level: "åº”ç”¨", explanation: "æ’æ°´æ³•æµ‹ä½“ç§¯ï¼š55 - 30 = 25mlã€‚ç‰©ä½“æ’å¼€çš„æ°´çš„ä½“ç§¯ç­‰äºç‰©ä½“æœ¬èº«çš„ä½“ç§¯ã€‚", type: "displacement", drawingParam: { start: 30, end: 55 } },
    { q: "ã€é«˜é˜¶æ€ç»´ã€‘å¦‚æœè¦è¿é€ä¸€è¢‹ç©ºæ°”ï¼Œä½ ä¼šé€‰æ‹©ä¸‹é¢å“ªç§å®¹å™¨ï¼Ÿ", options: ["A. çº¸è¢‹å­", "B. å¯†å°çš„å¡‘æ–™è¢‹", "C. ç½‘å…œ", "D. æ•å£çš„ç¯®å­"], answer: 1, level: "è¯„ä»·", explanation: "æ°”ä½“å®¹æ˜“æ‰©æ•£ï¼ˆæµåŠ¨æ€§ï¼‰ï¼Œå¿…é¡»ç”¨å¯†å°å®¹å™¨æ‰èƒ½è£…ä½ï¼Œå¦åˆ™ä¼šè·‘æ‰ã€‚", type: "normal" },
    { q: "ã€å®éªŒæ¢ç©¶ã€‘ä¹Œé¸¦å–æ°´çš„æ•…äº‹é‡Œï¼Œä¹Œé¸¦æŠŠçŸ³å­æŠ•å…¥ç“¶ä¸­ï¼Œæ°´ä½ä¸Šå‡äº†ã€‚è¿™è¯´æ˜å›ºä½“ï¼Ÿ", options: ["A. èƒ½æº¶è§£", "B. å æ®ç©ºé—´", "C. åªè¦æ˜¯çŸ³å¤´å°±ä¼šæµ®èµ·æ¥", "D. æ¯”æ°´è½»"], answer: 1, level: "ç†è§£", explanation: "å›ºä½“ä¹Ÿæœ‰ä½“ç§¯ï¼Œä¼šå æ®ç©ºé—´ï¼ŒæŠŠæ°´â€œæŒ¤â€äº†ä¸Šæ¥ã€‚", type: "normal" },
    { q: "ã€å·¥å…·åŒ¹é…ã€‘æˆ‘ä»¬è¦æµ‹é‡ç‰©ä½“çš„â€œä½“ç§¯â€ï¼ˆå æ®ç©ºé—´çš„å¤§å°ï¼‰ï¼Œåº”è¯¥é€‰æ‹©å›¾ä¸­çš„å“ªä¸ªå·¥å…·ï¼Ÿ", options: ["A. å·¥å…·â‘  (å¤©å¹³)", "B. å·¥å…·â‘¡ (ç›´å°º)", "C. å·¥å…·â‘¢ (é‡ç­’)", "D. éƒ½å¯ä»¥"], answer: 2, level: "åˆ†æ", explanation: "å¤©å¹³æµ‹è´¨é‡ï¼Œç›´å°ºæµ‹é•¿åº¦ï¼Œé‡ç­’ï¼ˆæˆ–é‡æ¯ï¼‰æ‰æ˜¯æµ‹é‡æ¶²ä½“æˆ–ä¸è§„åˆ™å›ºä½“ä½“ç§¯çš„å·¥å…·ã€‚", type: "tools", drawingParam: {} }
];

const canvas = document.getElementById('questionCanvas');
const ctx = canvas.getContext('2d');

// --- ğŸ”’ é˜²åˆ·é¢˜é€»è¾‘ï¼šé¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²æäº¤ ---
window.onload = function() {
    const savedData = localStorage.getItem('science_exam_result');
    if (savedData) {
        // å¦‚æœæœ¬åœ°æœ‰è®°å½•ï¼Œç›´æ¥æ˜¾ç¤ºç»“æœé¡µï¼Œä¸æ˜¾ç¤ºç™»å½•å¼¹çª—
        try {
            const result = JSON.parse(savedData);
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('game-area').style.display = 'none';
            
            // æ¢å¤æ˜¾ç¤ºæ•°æ®
            playerName = result.name;
            playerClass = result.class;
            
            // æ¸²æŸ“ä¹‹å‰çš„é”™é¢˜æŠ¥å‘Š
            const reviewList = document.getElementById('review-list');
            reviewList.innerHTML = result.reviewHtml;
            
            document.getElementById('player-class-display').textContent = result.class;
            document.getElementById('player-name-display').textContent = result.name;
            document.getElementById('final-score-display').textContent = `${result.score} / ${questions.length}`;
            document.getElementById('score-comment').textContent = result.comment;
            
            // æ˜¾ç¤ºå·²æäº¤æç¤º
            document.getElementById('result-screen').style.display = 'block';
            document.getElementById('already-submitted-msg').style.display = 'block';
            document.getElementById('upload-status').innerHTML = "âœ… å†å²æˆç»©å·²è¯»å–ï¼ˆæ— éœ€é‡å¤æäº¤ï¼‰";
            document.getElementById('upload-status').style.color = "green";
            
        } catch(e) {
            // å¦‚æœæ•°æ®æŸåï¼Œæ¸…é™¤é‡æ¥
            localStorage.removeItem('science_exam_result');
        }
    }
};

function startGame() {
    const classInput = document.getElementById('student-class');
    const nameInput = document.getElementById('student-name');
    if (!classInput.value) { alert("è¯·å…ˆé€‰æ‹©ä½ æ˜¯å“ªä¸ªç­çº§çš„åŒå­¦å“¦ï¼"); return; }
    if (!nameInput.value.trim()) { alert("è¯·å‘Šè¯‰è€å¸ˆä½ çš„åå­—ï¼Œæ–¹ä¾¿è®°å½•æˆç»©ï¼"); return; }
    playerClass = classInput.value;
    playerName = nameInput.value.trim();
    document.getElementById('login-modal').style.display = 'none';
    initGame();
}

function initGame() {
    currentQIndex = 0; userAnswers.fill(-1);
    document.getElementById('result-screen').style.display = 'none';
    document.getElementById('game-area').style.display = 'flex';
    loadQuestion();
}

function loadQuestion() {
    const qData = questions[currentQIndex];
    document.getElementById('question-text').innerHTML = `<span style="color:#00BCD4; font-size:0.9em; font-weight:bold;">ç¬¬ ${currentQIndex + 1} / ${questions.length} é¢˜</span><br>${qData.q}`;
    document.getElementById('progress').style.width = `${((currentQIndex) / questions.length) * 100}%`;
    document.getElementById('next-btn').style.display = 'none';
    renderCanvas(qData);
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';
    qData.options.forEach((opt, index) => {
        const btn = document.createElement('div');
        btn.className = 'option-btn';
        btn.textContent = opt;
        if (userAnswers[currentQIndex] === index) btn.classList.add('selected');
        btn.onclick = () => selectOption(index, btn);
        optionsContainer.appendChild(btn);
    });
}

function selectOption(index, btnElement) {
    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btnElement.classList.add('selected');
    userAnswers[currentQIndex] = index;
    const nextBtn = document.getElementById('next-btn');
    nextBtn.style.display = 'inline-block';
    if (currentQIndex === questions.length - 1) {
        nextBtn.textContent = "æäº¤è¯•å·";
        nextBtn.style.backgroundColor = "#4CAF50";
    } else {
        nextBtn.textContent = "ç¡®å®šï¼Œä¸‹ä¸€é¢˜";
        nextBtn.style.backgroundColor = "";
    }
}

function nextQuestion() {
    currentQIndex++;
    if (currentQIndex < questions.length) loadQuestion();
    else calculateAndShowResult();
}

function calculateAndShowResult() {
    document.getElementById('game-area').style.display = 'none';
    const resultScreen = document.getElementById('result-screen');
    resultScreen.style.display = 'block';
    
    let score = 0;
    let mistakeTextList = [];
    const reviewList = document.getElementById('review-list');
    reviewList.innerHTML = ''; // Clear previous

    questions.forEach((q, idx) => {
        const userChoiceIdx = userAnswers[idx];
        const isCorrect = (userChoiceIdx === q.answer);
        if (isCorrect) {
            score++;
        } else {
            const userOpt = q.options[userChoiceIdx] || "æœªä½œç­”";
            const correctOpt = q.options[q.answer];
            mistakeTextList.push(`ã€ç¬¬${idx+1}é¢˜ã€‘\nâ“ ${q.q}\nâŒ è¯¯é€‰ï¼š${userOpt}\nâœ… æ­£è§£ï¼š${correctOpt}`);
        }
        const item = document.createElement('div');
        item.className = `review-item ${isCorrect ? 'correct' : 'wrong'}`;
        let statusBadge = isCorrect ? '<span class="status-badge badge-correct">âœ… æ­£ç¡®</span>' : '<span class="status-badge badge-wrong">âŒ é”™è¯¯</span>';
        let compareHtml = isCorrect ? 
            `<div class="answer-compare"><span class="correct-text">ä½ çš„é€‰æ‹©: ${q.options[userChoiceIdx]}</span></div>` : 
            `<div class="answer-compare"><span class="wrong-text">ä½ çš„é€‰æ‹©: ${q.options[userChoiceIdx]}</span><br><span class="correct-text">æ­£ç¡®ç­”æ¡ˆ: ${q.options[q.answer]}</span></div>`;
        item.innerHTML = `<div class="review-status">${statusBadge} ç¬¬ ${idx+1} é¢˜</div><div class="review-q-title">${q.q.replace(/å¦‚ä¸Šå›¾/, 'è§é¢˜å›¾')}</div><div class="review-detail">${compareHtml}<div style="margin-top:8px; border-top:1px dashed #ccc; padding-top:5px;"><strong>ğŸ’¡ è€å¸ˆè§£æï¼š</strong>${q.explanation}</div></div>`;
        reviewList.appendChild(item);
    });

    document.getElementById('player-class-display').textContent = playerClass;
    document.getElementById('player-name-display').textContent = playerName;
    document.getElementById('final-score-display').textContent = `${score} / ${questions.length}`;
    
    const percent = score / questions.length;
    let comment = percent === 1 ? "å®Œç¾ï¼ä½ çš„ç§‘å­¦åŸºç¡€éå¸¸æ‰å®ï¼ğŸ‰" : (percent >= 0.8 ? "æˆç»©ä¼˜ç§€ï¼è¯·é‡ç‚¹æŸ¥çœ‹ä¸‹æ–¹çš„é”™é¢˜è§£æã€‚ğŸ‘" : (percent >= 0.6 ? "åŠæ ¼äº†ï¼Œä½†åŸºç¡€æ¦‚å¿µè¿˜æœ‰äº›æ¨¡ç³Šã€‚ğŸ’ª" : "éœ€è¦åŠ æ²¹å“¦ï¼å»ºè®®å¤ä¹ è¯¾æœ¬åå†æ¥æŒ‘æˆ˜ã€‚ğŸ“š"));
    document.getElementById('score-comment').textContent = comment;
    
    let mistakesString = mistakeTextList.length > 0 ? mistakeTextList.join("\n----------------------\n") : "æ— ï¼ˆæ»¡åˆ†ï¼‰";
    
    // --- ğŸ”’ ä¿å­˜åˆ°æœ¬åœ°ï¼Œé˜²æ­¢é‡å¤æäº¤ ---
    localStorage.setItem('science_exam_result', JSON.stringify({
        submitted: true,
        name: playerName,
        class: playerClass,
        score: score,
        comment: comment,
        reviewHtml: reviewList.innerHTML // ä¿å­˜ç”Ÿæˆçš„HTMLä»¥ä¾¿å›æ˜¾
    }));

    uploadToFeishu(score, mistakesString);
}

async function uploadToFeishu(score, mistakesString) {
    const statusDiv = document.getElementById('upload-status');
    
    if (APP_ID.includes("cli_xxxx")) {
        statusDiv.innerHTML = "âš ï¸ è¯·é…ç½® APP_ID å’Œ SECRET";
        statusDiv.style.color = "orange";
        return;
    }

    try {
        statusDiv.innerHTML = "â³ æ­£åœ¨è¿æ¥é£ä¹¦æœåŠ¡å™¨...";
        
        const authUrl = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal";
        const authRes = await fetch(PROXY_URL + encodeURIComponent(authUrl), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ "app_id": APP_ID, "app_secret": APP_SECRET })
        });
        
        const authData = await authRes.json();
        if (authData.code !== 0) throw new Error("è®¤è¯å¤±è´¥: " + (authData.msg || "æœªçŸ¥é”™è¯¯"));
        const token = authData.tenant_access_token;

        statusDiv.innerHTML = "â³ æ­£åœ¨ä¿å­˜æˆç»©...";
        const tableUrl = `https://open.feishu.cn/open-apis/bitable/v1/apps/${BITABLE_APP_TOKEN}/tables/${BITABLE_TABLE_ID}/records`;
        
        const recordRes = await fetch(PROXY_URL + encodeURIComponent(tableUrl), {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "fields": {
                    "class_name": playerClass,
                    "name": playerName,
                    "score": score,
                    "mistakes": mistakesString
                }
            })
        });

        const recordData = await recordRes.json();
        if (recordData.code === 0) {
            statusDiv.innerHTML = "âœ… æˆç»©å·²æˆåŠŸä¸Šä¼ ï¼";
            statusDiv.style.color = "green";
        } else {
            throw new Error("å†™å…¥å¤±è´¥: " + (recordData.msg || "æœªçŸ¥é”™è¯¯"));
        }

    } catch (err) {
        console.error("Upload Error:", err);
        statusDiv.innerHTML = "âŒ ä¸Šä¼ æ…¢æˆ–å¤±è´¥ï¼Œè¯·æˆªå›¾å‘ç»™è€å¸ˆï¼ˆå¯èƒ½æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼‰";
        statusDiv.style.color = "red";
    }
}

function renderCanvas(qData){ctx.clearRect(0,0,canvas.width,canvas.height);canvas.style.display='none';if(qData.type==='normal')return;canvas.style.display='block';ctx.strokeStyle='#f5f5f5';ctx.lineWidth=1;ctx.beginPath();for(let i=0;i<canvas.width;i+=20){ctx.moveTo(i,0);ctx.lineTo(i,canvas.height)}for(let i=0;i<canvas.height;i+=20){ctx.moveTo(0,i);ctx.lineTo(canvas.width,i)}ctx.stroke();switch(qData.type){case'cylinder':drawCylinder(qData.drawingParam.level);break;case'syringe':drawSyringe();break;case'balance':drawBalance(qData.drawingParam.tilt);break;case'displacement':drawDisplacement(qData.drawingParam.start,qData.drawingParam.end);break;case'dissolve':drawDissolve();break;case'separation':drawSeparation();break;case'sieve':drawSieve();break;case'tools':drawTools();break}}
function drawCylinder(l){const x=160,y=20,w=80,h=180;ctx.fillStyle='#fff';ctx.strokeStyle='#666';ctx.lineWidth=2;ctx.fillRect(x,y,w,h);ctx.strokeRect(x,y,w,h);let t=(y+h)-(l*(h/50)),ry=6,cy=t-ry;ctx.fillStyle='#4FC3F7';ctx.fillRect(x+1,cy,w-2,(y+h)-cy);ctx.fillStyle='#E1F5FE';ctx.beginPath();ctx.ellipse(x+w/2,cy,w/2-1,ry,0,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#4FC3F7';ctx.stroke();ctx.fillStyle='#333';ctx.font="14px Arial";ctx.textAlign="right";for(let i=10;i<=50;i+=10){let ty=(y+h)-(i*(h/50));ctx.beginPath();ctx.moveTo(x,ty);ctx.lineTo(x+20,ty);ctx.stroke();ctx.fillText(i+"ml",x-5,ty+5);if(i===l){ctx.save();ctx.strokeStyle='red';ctx.setLineDash([2,2]);ctx.beginPath();ctx.moveTo(x,ty);ctx.lineTo(x+w,ty);ctx.stroke();ctx.restore();}}}
function drawSieve(){ctx.strokeStyle='#795548';ctx.lineWidth=4;ctx.strokeRect(100,100,200,20);ctx.lineWidth=1;ctx.beginPath();for(let i=100;i<=300;i+=10){ctx.moveTo(i,100);ctx.lineTo(i,120)}for(let i=100;i<=120;i+=5){ctx.moveTo(100,i);ctx.lineTo(300,i)}ctx.stroke();ctx.lineWidth=5;ctx.beginPath();ctx.moveTo(300,110);ctx.lineTo(360,110);ctx.stroke();ctx.fillStyle='#4CAF50';for(let i=0;i<8;i++){ctx.beginPath();ctx.arc(120+Math.random()*160,90+Math.random()*10,6,0,Math.PI*2);ctx.fill()}ctx.fillStyle='#FFF9C4';for(let i=0;i<30;i++){ctx.beginPath();ctx.arc(110+Math.random()*180,130+Math.random()*50,1.5,0,Math.PI*2);ctx.fill()}ctx.fillStyle='#333';ctx.textAlign="center";ctx.fillText("ç»¿è±†(å¤§)ç•™åœ¨ä¸Šé¢",200,60);ctx.fillText("é¢ç²‰(å°)æ¼ä¸‹æ¥",200,200)}
function drawSyringe(){ctx.strokeStyle='#555';ctx.lineWidth=3;ctx.strokeRect(100,70,180,80);ctx.fillStyle='#ddd';ctx.fillRect(240,75,30,70);ctx.fillStyle='#B3E5FC';ctx.fillRect(100,72,140,76);ctx.fillStyle='#0277BD';for(let i=0;i<15;i++){ctx.beginPath();ctx.arc(120+Math.random()*100,80+Math.random()*60,3,0,Math.PI*2);ctx.fill()}ctx.fillStyle='#FFCCBC';ctx.beginPath();ctx.arc(300,110,25,0,Math.PI*2);ctx.fill();ctx.fillStyle='#333';ctx.font="16px Arial";ctx.textAlign="center";ctx.fillText("ç”¨åŠ›æ¨ ->",250,50)}
function drawDissolve(){ctx.strokeStyle='#333';ctx.lineWidth=3;ctx.strokeRect(140,40,120,140);ctx.fillStyle='#E1F5FE';ctx.fillRect(142,80,116,98);ctx.strokeStyle='#aaa';ctx.lineWidth=6;ctx.beginPath();ctx.moveTo(250,20);ctx.lineTo(200,100);ctx.stroke();ctx.fillStyle='#888';for(let i=0;i<50;i++){ctx.beginPath();ctx.arc(150+Math.random()*100,90+Math.random()*80,1.5,0,Math.PI*2);ctx.fill()}ctx.fillStyle='#333';ctx.fillText("æ…æ‹Œå...",200,200)}
function drawSeparation(){ctx.strokeStyle='#333';ctx.lineWidth=3;ctx.strokeRect(140,40,120,140);ctx.fillStyle='#E1F5FE';ctx.fillRect(142,70,116,108);ctx.fillStyle='#8D6E63';for(let i=0;i<15;i++){ctx.fillRect(150+Math.random()*100,75+Math.random()*10,8,4)}ctx.fillStyle='#9E9E9E';for(let i=0;i<30;i++){ctx.beginPath();ctx.arc(145+Math.random()*110,170+Math.random()*8,2,0,Math.PI*2);ctx.fill()}}
function drawBalance(t){ctx.save();ctx.fillStyle='#455A64';ctx.fillRect(190,150,20,50);ctx.fillRect(150,200,100,10);ctx.translate(200,150);ctx.rotate(t*0.2);ctx.fillStyle='#CFD8DC';ctx.fillRect(-120,-5,240,10);ctx.strokeStyle='#455A64';ctx.beginPath();ctx.moveTo(-115,-5);ctx.lineTo(-115,30);ctx.moveTo(-115,30);ctx.lineTo(-135,50);ctx.lineTo(-95,50);ctx.lineTo(-115,30);ctx.moveTo(115,-5);ctx.lineTo(115,30);ctx.moveTo(115,30);ctx.lineTo(95,50);ctx.lineTo(135,50);ctx.lineTo(115,30);ctx.stroke();ctx.fillStyle='red';ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-5,30);ctx.lineTo(5,30);ctx.fill();ctx.restore()}
function drawDisplacement(s,e){ctx.font="14px Arial";ctx.textAlign="center";ctx.strokeStyle='#555';ctx.strokeRect(80,60,50,120);let h1=(s/100)*120;ctx.fillStyle='#4FC3F7';ctx.fillRect(80,180-h1,50,h1);ctx.fillStyle='#333';ctx.fillText("30ml",105,50);ctx.strokeRect(270,60,50,120);let h2=(e/100)*120;ctx.fillStyle='#4FC3F7';ctx.fillRect(270,180-h2,50,h2);ctx.fillStyle='#5D4037';ctx.beginPath();ctx.arc(295,170,15,0,Math.PI*2);ctx.fill();ctx.fillStyle='#333';ctx.fillText("55ml",295,50);ctx.beginPath();ctx.moveTo(150,120);ctx.lineTo(250,120);ctx.lineTo(240,110);ctx.moveTo(250,120);ctx.lineTo(240,130);ctx.strokeStyle='#333';ctx.lineWidth=2;ctx.stroke();ctx.fillText("+ çŸ³å¤´",200,110)}
function drawTools(){ctx.fillStyle='#333';ctx.textAlign="center";ctx.font="14px Arial";ctx.fillText("â‘ ",80,40);ctx.fillStyle='#90A4AE';ctx.fillRect(50,140,60,5);ctx.fillRect(78,100,4,40);ctx.fillRect(50,100,60,4);ctx.fillStyle='#333';ctx.fillText("â‘¡",200,40);ctx.fillStyle='#FFCC80';ctx.fillRect(190,60,20,100);ctx.strokeStyle='#333';ctx.lineWidth=1;for(let i=0;i<10;i++){ctx.beginPath();ctx.moveTo(205,70+i*10);ctx.lineTo(210,70+i*10);ctx.stroke()}ctx.fillStyle='#333';ctx.fillText("â‘¢",320,40);ctx.strokeStyle='#555';ctx.lineWidth=2;ctx.strokeRect(300,80,40,80);ctx.fillStyle='#4FC3F7';ctx.fillRect(300,120,40,40)}
</script>
</body>
</html>